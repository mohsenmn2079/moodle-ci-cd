{"version":3,"file":"exporter.min.js","sources":["../../../src/local/activitychooser/exporter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to generate template data for the activity chooser.\n *\n * @module     core_course/local/activitychooser/exporter\n * @copyright  2025 Ferran Recio <ferran@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getStrings} from 'core/str';\n\nconst activityCategories = [\n    'administration',\n    'assessment',\n    'collaboration',\n    'communication',\n    'content',\n    'interactivecontent',\n];\n\nlet allStrings = null;\n\nloadNecessaryStrings();\n\nexport default class {\n    /**\n     * A tab data structure.\n     *\n     * @typedef {object} TabData\n     * @property {String} tabId the tab ID\n     * @property {Boolean} active whether the tab is active or not\n     * @property {Array} items the filtered modules to be displayed in the tab\n     * @property {Boolean} displayed whether the tab is displayed or not\n     * @property {String} tabLabel the tab label\n     * @property {String|null} tabHelp the help text for the tab (optional)\n     */\n\n    /**\n     * Generate a tab data object for the activity chooser.\n     *\n     * @private\n     * @param {String} tabId Tab ID.\n     * @param {Array} filteredModules Filtered modules to be displayed in the tab.\n     * @param {String} tabLabel Tab label.\n     * @param {String|null} tabHelp Help text for the tab (optional).\n     * @param {Boolean} active Whether the tab is active or not.\n     * @return {TabData} Tab data object.\n     */\n    getTabData(tabId, filteredModules, tabLabel, tabHelp = null, active = false) {\n        const result = {\n            tabId: tabId,\n            active: active,\n            items: filteredModules,\n            displayed: filteredModules.length > 0,\n            tabLabel,\n        };\n        if (tabHelp) {\n            result.tabHelp = tabHelp;\n        }\n        return result;\n    }\n\n    /**\n     * Normalise the modules data to be used in the chooser.\n     *\n     * The modulesData can be a plain array or a Map. This method will convert it to a\n     * plain array of objects.\n     *\n     * @param {Array|Map} modulesData Modules data to be used in the chooser.\n     * @return {Array} Normalised modules data.\n     */\n    normaliseModulesData(modulesData) {\n        if (modulesData instanceof Map) {\n            modulesData = Array.from(modulesData.values());\n        } else if (!Array.isArray(modulesData)) {\n            throw new Error('Invalid modules data format. Expected an array or a Map.');\n        }\n        return modulesData;\n    }\n\n    /**\n     * Fetch the chooser template data for a specific section.\n     *\n     * @param {Array|Map} modulesData Modules data to be used in the chooser.\n     * @return {Promise<Object>} Promise resolved with the template data.\n     */\n    async getModChooserTemplateData(modulesData) {\n        modulesData = this.normaliseModulesData(modulesData);\n        const allStrings = await loadNecessaryStrings();\n        const favouriteTab = await this.getFavouriteTabData(modulesData);\n\n        const tabs = [\n            {\n                ...this.getTabData(\n                    'all',\n                    modulesData,\n                    allStrings.all,\n                    null,\n                    !favouriteTab.displayed,\n                ),\n                hasSearchResults: true, // The all tab will also show search results.\n            },\n            favouriteTab,\n            {\n                ...this.getTabData(\n                    'recommended',\n                    modulesData.filter(mod => mod.recommended === true),\n                    allStrings.recommended,\n                    allStrings.recommended_help\n                ),\n                separator: true, // Add a separator before the purpose categories.\n            },\n        ];\n\n        activityCategories.forEach((category) => {\n            const categoryModules = modulesData.filter(mod => mod.purpose == category);\n            if (categoryModules.length === 0) {\n                return;\n            }\n            tabs.push(\n                this.getTabData(\n                    category,\n                    categoryModules,\n                    allStrings['mod_purpose_' + category],\n                    allStrings['mod_purpose_' + category + '_help']\n                )\n            );\n        });\n\n        return {\n            modules: modulesData,\n            tabs,\n        };\n    }\n\n    /**\n     * Get the favourite tab data.\n     *\n     * @param {Array|Map} modulesData Modules data to be used in the chooser.\n     * @return {Promise<TabData>} Promise resolved with the template data.\n     */\n    async getFavouriteTabData(modulesData) {\n        modulesData = this.normaliseModulesData(modulesData);\n        const allStrings = await loadNecessaryStrings();\n\n        // We need to deconstruct the modules data to ensure it is an array.\n        const favouriteModules = modulesData.filter(\n            mod => {\n                return mod.favourite === true;\n            }\n        );\n\n        return this.getTabData(\n            'favourites',\n            favouriteModules,\n            allStrings.favourites,\n            null,\n            favouriteModules.length > 0,\n        );\n    }\n\n    /**\n     * Get the search result template data.\n     *\n     * @param {Array|Map} resultsModulesData Modules data to be used in the chooser.\n     * @return {Object} The template data.\n     */\n    getSearchResultData(resultsModulesData) {\n        resultsModulesData = this.normaliseModulesData(resultsModulesData);\n        return {\n            'searchresultsnumber': resultsModulesData.length,\n            'searchresults': resultsModulesData,\n        };\n    }\n\n    /**\n     * Get the number of items in a tab.\n     *\n     * @param {TabData} tabData The tab data.\n     * @return {Number} The number of items in the tab.\n     */\n    countTabItems(tabData) {\n        return tabData.items?.length ?? 0;\n    }\n\n}\n\n/**\n * Load the necessary strings for the activity chooser.\n *\n * @return {Promise<Object>} Promise resolved with the loaded strings.\n */\nasync function loadNecessaryStrings() {\n    if (allStrings !== null) {\n        return allStrings;\n    }\n    allStrings = {};\n\n    const stringToLoad = [\n        {key: 'all', component: 'core'},\n        {key: 'favourites', component: 'core'},\n        {key: 'recommended', component: 'core'},\n        {key: 'recommended_help', component: 'core_course'},\n        ...activityCategories.map(\n            (key) => ({\n                key: 'mod_purpose_' + key,\n                component: 'core_course',\n            })\n        ),\n        ...activityCategories.map(\n            (key) => ({\n                key: 'mod_purpose_' + key + '_help',\n                component: 'core_course',\n            })\n        ),\n    ];\n\n    const loadedStrings = await getStrings(stringToLoad);\n    stringToLoad.forEach(({key}, index) => {\n        allStrings[key] = loadedStrings[index];\n    });\n    return allStrings;\n}\n"],"names":["activityCategories","allStrings","loadNecessaryStrings","stringToLoad","key","component","map","loadedStrings","forEach","index","getTabData","tabId","filteredModules","tabLabel","tabHelp","result","active","items","displayed","length","normaliseModulesData","modulesData","Map","Array","from","values","isArray","Error","this","favouriteTab","getFavouriteTabData","tabs","all","hasSearchResults","filter","mod","recommended","recommended_help","separator","category","categoryModules","purpose","push","modules","favouriteModules","favourite","favourites","getSearchResultData","resultsModulesData","countTabItems","tabData","_tabData$items"],"mappings":";;;;;;;;MAyBMA,mBAAqB,CACvB,iBACA,aACA,gBACA,gBACA,UACA,0BAGAC,WAAa,KAEjBC,sCA0KeA,0BACQ,OAAfD,kBACOA,WAEXA,WAAa,SAEPE,aAAe,CACjB,CAACC,IAAK,MAAOC,UAAW,QACxB,CAACD,IAAK,aAAcC,UAAW,QAC/B,CAACD,IAAK,cAAeC,UAAW,QAChC,CAACD,IAAK,mBAAoBC,UAAW,kBAClCL,mBAAmBM,KACjBF,OACGA,IAAK,eAAiBA,IACtBC,UAAW,qBAGhBL,mBAAmBM,KACjBF,OACGA,IAAK,eAAiBA,IAAM,QAC5BC,UAAW,mBAKjBE,oBAAsB,mBAAWJ,qBACvCA,aAAaK,SAAQ,MAAQC,aAAPL,IAACA,UACnBH,WAAWG,KAAOG,cAAcE,UAE7BR,yCA7KPS,WAAWC,MAAOC,gBAAiBC,cAAUC,+DAAU,WAC7CC,OAAS,CACXJ,MAAOA,MACPK,+DACAC,MAAOL,gBACPM,UAAWN,gBAAgBO,OAAS,EACpCN,SAAAA,iBAEAC,UACAC,OAAOD,QAAUA,SAEdC,OAYXK,qBAAqBC,gBACbA,uBAAuBC,IACvBD,YAAcE,MAAMC,KAAKH,YAAYI,eAClC,IAAKF,MAAMG,QAAQL,mBAChB,IAAIM,MAAM,mEAEbN,4CASqBA,aAC5BA,YAAcO,KAAKR,qBAAqBC,mBAClCpB,iBAAmBC,uBACnB2B,mBAAqBD,KAAKE,oBAAoBT,aAE9CU,KAAO,CACT,IACOH,KAAKlB,WACJ,MACAW,YACApB,WAAW+B,IACX,MACCH,aAAaX,WAElBe,kBAAkB,GAEtBJ,aACA,IACOD,KAAKlB,WACJ,cACAW,YAAYa,QAAOC,MAA2B,IAApBA,IAAIC,cAC9BnC,WAAWmC,YACXnC,WAAWoC,kBAEfC,WAAW,WAInBtC,mBAAmBQ,SAAS+B,iBAClBC,gBAAkBnB,YAAYa,QAAOC,KAAOA,IAAIM,SAAWF,WAClC,IAA3BC,gBAAgBrB,QAGpBY,KAAKW,KACDd,KAAKlB,WACD6B,SACAC,gBACAvC,WAAW,eAAiBsC,UAC5BtC,WAAW,eAAiBsC,SAAW,cAK5C,CACHI,QAAStB,YACTU,KAAAA,gCAUkBV,aACtBA,YAAcO,KAAKR,qBAAqBC,mBAClCpB,iBAAmBC,uBAGnB0C,iBAAmBvB,YAAYa,QACjCC,MAC6B,IAAlBA,IAAIU,mBAIZjB,KAAKlB,WACR,aACAkC,iBACA3C,WAAW6C,WACX,KACAF,iBAAiBzB,OAAS,GAUlC4B,oBAAoBC,0BAET,sBADPA,mBAAqBpB,KAAKR,qBAAqB4B,qBAED7B,qBACzB6B,oBAUzBC,cAAcC,8GACHA,QAAQjC,uCAARkC,eAAehC,8DAAU"}